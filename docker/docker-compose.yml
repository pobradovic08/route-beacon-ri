services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: rib
      POSTGRES_USER: rib
      POSTGRES_PASSWORD: rib
    volumes:
      - ../migrations/0001_init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ../migrations/0002_indexes.sql:/docker-entrypoint-initdb.d/02_indexes.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rib -d rib"]
      interval: 2s
      timeout: 3s
      retries: 15
    networks:
      - testnet

  kafka:
    image: apache/kafka:latest
    environment:
      KAFKA_NODE_ID: "1"
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 5s
      timeout: 10s
      retries: 15
    networks:
      - testnet

  gobmp:
    build:
      context: ./gobmp
      dockerfile: Dockerfile
    command:
      - -source-port=5000
      - -kafka-server=kafka:9092
      - -split-af=true
      - -v=5
    depends_on:
      kafka:
        condition: service_healthy
    restart: on-failure
    networks:
      testnet:
        ipv4_address: 172.30.0.10

  route-generator:
    image: quay.io/frrouting/frr:10.3.1
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    volumes:
      - ./frr/daemons:/etc/frr/daemons:ro
      - ./frr/frr-generator.conf:/etc/frr/frr.conf:ro
    networks:
      testnet:
        ipv4_address: 172.30.0.30

  bgp-router:
    image: quay.io/frrouting/frr:10.3.1
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    volumes:
      - ./frr/daemons:/etc/frr/daemons:ro
      - ./frr/frr.conf:/etc/frr/frr.conf:ro
    depends_on:
      gobmp:
        condition: service_started
      route-generator:
        condition: service_started
    networks:
      testnet:
        ipv4_address: 172.30.0.20

  rib-ingester:
    build:
      context: ..
      dockerfile: Dockerfile
    entrypoint: ["sh", "-c", "/usr/local/bin/rib-ingester maintenance --config /etc/rib-ingester/config.yaml && /usr/local/bin/rib-ingester serve --config /etc/rib-ingester/config.yaml"]
    volumes:
      - ./rib-ingester/config.yaml:/etc/rib-ingester/config.yaml:ro
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - testnet

networks:
  testnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
